"""
Tilt Detector - PhÃ¡t hiá»‡n tráº¡ng thÃ¡i tilt (emotional trading)
"""

from dataclasses import dataclass, field
from typing import Optional, List
from datetime import datetime, timedelta


@dataclass
class SessionStats:
    """User session statistics"""
    trade_count: int = 0
    win_count: int = 0
    loss_count: int = 0
    session_pnl: float = 0.0
    current_drawdown_pct: float = 0.0
    session_duration_hours: float = 0.0
    avg_trades_per_hour: float = 1.0
    trades_last_hour: int = 0


@dataclass
class Alert:
    """Alert generated by detector"""
    alert_type: str
    severity: str
    score: int
    reasons: List[str] = field(default_factory=list)
    recommendation: str = ""
    
    def to_dict(self) -> dict:
        return {
            "alert_type": self.alert_type,
            "severity": self.severity,
            "score": self.score,
            "reasons": self.reasons,
            "recommendation": self.recommendation
        }


class TiltDetector:
    """
    PhÃ¡t hiá»‡n Tilt (emotional trading) dá»±a trÃªn:
    1. Drawdown vÆ°á»£t ngÆ°á»¡ng
    2. Trade frequency tÄƒng Ä‘á»™t biáº¿n
    3. Win rate session tháº¥p
    4. Nhiá»u trades trong thá»i gian ngáº¯n
    5. Keywords thá»ƒ hiá»‡n tÃ¢m lÃ½ tiÃªu cá»±c
    """
    
    TILT_KEYWORDS = [
        # Vietnamese - frustration/anger
        "bá»±c", "Ä‘iÃªn", "tá»©c", "náº£n", "chÃ¡n",
        "má»‡t má»i", "stress", "Ã¡p lá»±c", "khÃ´ng hiá»ƒu",
        "sai hoÃ i", "thua mÃ£i", "thá»‹ trÆ°á»ng Ä‘iÃªn",
        "market maker", "bá»‹ scam", "bá»‹ lá»«a",
        # Vietnamese - desperation  
        "cuá»‘i cÃ¹ng", "láº§n nÃ y pháº£i tháº¯ng", "táº¥t tay",
        "load thÃªm tiá»n", "náº¡p thÃªm", "gá»¡ báº±ng má»i giÃ¡",
        # English
        "frustrated", "angry", "tilted", "fed up",
        "doesn't make sense", "rigged", "manipulated",
        "one more trade", "last trade", "all in",
        "need to win"
    ]
    
    def detect(
        self,
        notes: Optional[str],
        session_stats: Optional[SessionStats] = None
    ) -> Optional[Alert]:
        """
        Detect tilt (emotional state) in trading.
        
        Args:
            notes: Trade notes from user
            session_stats: Statistics from current trading session
            
        Returns:
            Alert if tilt detected, None otherwise
        """
        score = 0
        reasons = []
        
        if session_stats:
            # Check 1: Current drawdown
            drawdown = session_stats.current_drawdown_pct
            if drawdown > 10:
                score += 45
                reasons.append(f"ğŸ”´ Drawdown Ráº¤T CAO: {drawdown:.1f}%!")
            elif drawdown > 7:
                score += 35
                reasons.append(f"ğŸŸ  Drawdown cao: {drawdown:.1f}%")
            elif drawdown > 5:
                score += 25
                reasons.append(f"ğŸŸ¡ Äang drawdown: {drawdown:.1f}%")
            elif drawdown > 3:
                score += 10
                reasons.append(f"ğŸ“‰ Drawdown nháº¹: {drawdown:.1f}%")
            
            # Check 2: Trade frequency spike
            if session_stats.avg_trades_per_hour > 0:
                frequency_ratio = session_stats.trades_last_hour / max(session_stats.avg_trades_per_hour, 0.5)
                
                if frequency_ratio > 3:
                    score += 35
                    reasons.append(f"âš¡ Trading quÃ¡ nhiá»u: gáº¥p {frequency_ratio:.1f}x bÃ¬nh thÆ°á»ng!")
                elif frequency_ratio > 2:
                    score += 25
                    reasons.append(f"ğŸ“ˆ Trade frequency cao: gáº¥p {frequency_ratio:.1f}x")
                elif frequency_ratio > 1.5:
                    score += 15
                    reasons.append(f"ğŸ“Š Trade hÆ¡i nhiá»u so vá»›i bÃ¬nh thÆ°á»ng")
            
            # Check 3: Poor session win rate with enough trades
            if session_stats.trade_count >= 5:
                win_rate = session_stats.win_count / session_stats.trade_count
                
                if win_rate < 0.2:
                    score += 40
                    reasons.append(f"ğŸ”´ Win rate session Ráº¤T THáº¤P: {win_rate*100:.0f}%!")
                elif win_rate < 0.3:
                    score += 30
                    reasons.append(f"ğŸŸ  Win rate session tháº¥p: {win_rate*100:.0f}%")
                elif win_rate < 0.4:
                    score += 15
                    reasons.append(f"ğŸ“‰ Win rate session: {win_rate*100:.0f}%")
            
            # Check 4: Too many trades in session
            if session_stats.trade_count > 15:
                score += 25
                reasons.append(f"âš ï¸ QuÃ¡ nhiá»u trades trong session: {session_stats.trade_count}")
            elif session_stats.trade_count > 10:
                score += 15
                reasons.append(f"ğŸ“Š Nhiá»u trades trong session: {session_stats.trade_count}")
            
            # Check 5: Long session with poor performance
            if session_stats.session_duration_hours > 4 and session_stats.current_drawdown_pct > 3:
                score += 20
                reasons.append(f"â° Trading quÃ¡ lÃ¢u ({session_stats.session_duration_hours:.1f}h) trong lÃºc thua lá»—")
        
        # Check 6: Tilt keywords in notes
        if notes:
            note_lower = notes.lower()
            matched_keywords = [k for k in self.TILT_KEYWORDS if k in note_lower]
            
            if matched_keywords:
                keyword_score = min(len(matched_keywords) * 15, 35)
                score += keyword_score
                reasons.append(f"ğŸ” PhÃ¡t hiá»‡n tÃ¢m lÃ½ TILT: {', '.join(matched_keywords[:3])}")
        
        # Generate alert if score is high enough
        if score >= 50:
            severity = self._get_severity(score)
            
            if score >= 85:
                recommendation = "ğŸ›‘ Dá»ªNG NGAY VÃ€ NGHá»ˆ! Báº¡n Ä‘ang tilt nghiÃªm trá»ng. KhÃ´ng trade trong Ã­t nháº¥t 3-4 tiáº¿ng hoáº·c ngÃ y mai má»›i trade tiáº¿p."
            elif score >= 70:
                recommendation = "âš ï¸ NGHá»ˆ NGAY! Tilt detected. Nghá»‰ Ã­t nháº¥t 2 tiáº¿ng. Äi dáº¡o, táº­p thá»ƒ dá»¥c, hoáº·c lÃ m viá»‡c khÃ¡c."
            elif score >= 55:
                recommendation = "ğŸ’¡ Cáº¢NH BÃO: CÃ³ dáº¥u hiá»‡u tilt. Nghá»‰ 30-60 phÃºt trÆ°á»›c khi tiáº¿p tá»¥c."
            else:
                recommendation = "ğŸ“‹ LÆ°u Ã½: TÃ¢m lÃ½ cÃ³ thá»ƒ Ä‘ang bá»‹ áº£nh hÆ°á»Ÿng. Consider taking a break."
            
            return Alert(
                alert_type="TILT",
                severity=severity,
                score=score,
                reasons=reasons,
                recommendation=recommendation
            )
        
        return None
    
    def _get_severity(self, score: int) -> str:
        """Get severity level based on score"""
        if score >= 85:
            return "CRITICAL"
        elif score >= 70:
            return "HIGH"
        elif score >= 55:
            return "MEDIUM"
        else:
            return "INFO"
