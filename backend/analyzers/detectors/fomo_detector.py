"""
FOMO Detector - PhÃ¡t hiá»‡n hÃ nh vi FOMO (Fear of Missing Out)
"""

from dataclasses import dataclass, field
from typing import Optional, List
from datetime import datetime


@dataclass
class MarketContext:
    """Market context at time of trade"""
    price_change_pct_1h: float = 0.0
    price_change_pct_24h: float = 0.0
    is_near_local_high: bool = False
    volume_ratio: float = 1.0  # current volume / avg volume


@dataclass
class Alert:
    """Alert generated by detector"""
    alert_type: str
    severity: str  # 'INFO', 'MEDIUM', 'HIGH', 'CRITICAL'
    score: int  # 0-100
    reasons: List[str] = field(default_factory=list)
    recommendation: str = ""
    
    def to_dict(self) -> dict:
        return {
            "alert_type": self.alert_type,
            "severity": self.severity,
            "score": self.score,
            "reasons": self.reasons,
            "recommendation": self.recommendation
        }


class FOMODetector:
    """
    PhÃ¡t hiá»‡n FOMO dá»±a trÃªn:
    1. Price Ä‘Ã£ pump >X% trong Y phÃºt trÆ°á»›c entry
    2. Keywords kháº©n cáº¥p trong note
    3. Entry ngay sau breakout/pump
    """
    
    FOMO_KEYWORDS = [
        # Vietnamese
        "pháº£i vÃ o ngay", "mua gáº¥p", "sá»£ lá»¡", "khÃ´ng ká»‹p",
        "Ä‘ang bay", "pump rá»“i", "fomo", "all in", "chá»‘t liá»n",
        "báº¯t Ä‘Ã¡y", "Ä‘uá»•i giÃ¡", "lá»¡ tÃ u", "sá»£ miss",
        # English
        "must buy now", "hurry", "missing out", "can't miss",
        "pump", "going up fast", "get in now", "before too late"
    ]
    
    def detect(
        self, 
        notes: Optional[str], 
        market_context: Optional[MarketContext] = None,
        entry_price: Optional[float] = None
    ) -> Optional[Alert]:
        """
        Detect FOMO behavior.
        
        Args:
            notes: Trade notes from user
            market_context: Market conditions at entry
            entry_price: Entry price of the trade
            
        Returns:
            Alert if FOMO detected, None otherwise
        """
        score = 0
        reasons = []
        
        # Check 1: Price pump before entry (if market context available)
        if market_context:
            price_change_1h = market_context.price_change_pct_1h
            
            if price_change_1h > 8:
                score += 45
                reasons.append(f"ðŸš€ Price Ä‘Ã£ tÄƒng {price_change_1h:.1f}% trong 1h qua - FOMO RISK CAO!")
            elif price_change_1h > 5:
                score += 35
                reasons.append(f"ðŸ“ˆ Price Ä‘Ã£ tÄƒng {price_change_1h:.1f}% trong 1h qua")
            elif price_change_1h > 3:
                score += 20
                reasons.append(f"ðŸ“Š Price Ä‘Ã£ tÄƒng {price_change_1h:.1f}% trong 1h qua")
            
            # Check if entry is near local high
            if market_context.is_near_local_high:
                score += 25
                reasons.append("âš ï¸ Entry gáº§n Ä‘á»‰nh local (top 2%)")
            
            # High volume can indicate FOMO buying
            if market_context.volume_ratio > 3:
                score += 15
                reasons.append(f"ðŸ“Š Volume cao báº¥t thÆ°á»ng ({market_context.volume_ratio:.1f}x trung bÃ¬nh)")
        
        # Check 2: Keywords in notes
        if notes:
            note_lower = notes.lower()
            matched_keywords = [k for k in self.FOMO_KEYWORDS if k in note_lower]
            
            if matched_keywords:
                keyword_score = min(len(matched_keywords) * 15, 40)
                score += keyword_score
                reasons.append(f"ðŸ” PhÃ¡t hiá»‡n keywords FOMO: {', '.join(matched_keywords[:3])}")
        
        # Generate alert if score is high enough
        if score >= 40:
            severity = self._get_severity(score)
            
            if score >= 70:
                recommendation = "ðŸ›‘ Dá»ªNG Láº I! Chá» pullback hoáº·c skip trade nÃ y. FOMO thÆ°á»ng dáº«n Ä‘áº¿n entry xáº¥u."
            elif score >= 50:
                recommendation = "âš ï¸ CÃ¢n nháº¯c: Giáº£m size 50%, Ä‘áº·t SL cháº·t, hoáº·c chá» pullback."
            else:
                recommendation = "ðŸ’¡ LÆ°u Ã½: Kiá»ƒm tra láº¡i lÃ½ do vÃ o lá»‡nh. CÃ³ pháº£i FOMO khÃ´ng?"
            
            return Alert(
                alert_type="FOMO",
                severity=severity,
                score=score,
                reasons=reasons,
                recommendation=recommendation
            )
        
        return None
    
    def _get_severity(self, score: int) -> str:
        """Get severity level based on score"""
        if score >= 80:
            return "CRITICAL"
        elif score >= 60:
            return "HIGH"
        elif score >= 40:
            return "MEDIUM"
        else:
            return "INFO"
